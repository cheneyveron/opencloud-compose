---
services:
  opencloud:
   environment:
      STORAGE_USERS_FILEMETADATA_CACHE_STORE: redis-sentinel
      STORAGE_USERS_ID_CACHE_STORE: redis-sentinel
      OC_CACHE_STORE: redis-sentinel
      OC_CACHE_STORE_NODES: redis-sentinel-1:26379/redismaster,redis-sentinel-2:26379/redismaster
      OC_CACHE_TTL: 3600
      OC_CACHE_DATABASE: 0

  storage-users:
   environment:
      STORAGE_USERS_FILEMETADATA_CACHE_STORE: redis-sentinel
      STORAGE_USERS_ID_CACHE_STORE: redis-sentinel
      OC_CACHE_STORE: redis-sentinel
      OC_CACHE_STORE_NODES: redis-sentinel-1:26379/redismaster,redis-sentinel-2:26379/redismaster
      OC_CACHE_TTL: 3600
      OC_CACHE_DATABASE: 0

  # Redis Master
  redismaster:
    image: redis:7-alpine
    container_name: redis-master
    hostname: redismaster
    volumes:
       - ./container_data/redis:/data
    command:
      [
        "redis-server",
        "--appendonly",
        "yes",
        "--repl-diskless-load",
        "on-empty-db",
        "--replica-announce-port",
        "6379",
        "--protected-mode",
        "no"
      ]
    networks:
      opencloud-net:
        aliases:
          - redismaster
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis Sentinel 1
  redis-sentinel-1:
    image: redis:7-alpine
    container_name: redis-sentinel-1
    hostname: redis-sentinel-1
    command: >
      sh -c "
        echo 'port 26379' > /tmp/sentinel.conf &&
        echo 'sentinel monitor redismaster redismaster 6379 2' >> /tmp/sentinel.conf &&
        echo 'sentinel resolve-hostnames yes' >> /tmp/sentinel.conf &&
        echo 'sentinel down-after-milliseconds redismaster 5000' >> /tmp/sentinel.conf &&
        echo 'sentinel parallel-syncs redismaster 1' >> /tmp/sentinel.conf &&
        echo 'sentinel failover-timeout redismaster 10000' >> /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      "
    ports:
      - "26379:26379"
    depends_on:
      redismaster:
        condition: service_healthy
    networks:
      - opencloud-net
    restart: unless-stopped

  # Redis Sentinel 2
  redis-sentinel-2:
    image: redis:7-alpine
    container_name: redis-sentinel-2
    hostname: redis-sentinel-2
    command: >
      sh -c "
        echo 'port 26379' > /tmp/sentinel.conf &&
        echo 'sentinel monitor redismaster redismaster 6379 2' >> /tmp/sentinel.conf &&
        echo 'sentinel resolve-hostnames yes' >> /tmp/sentinel.conf &&
        echo 'sentinel down-after-milliseconds redismaster 5000' >> /tmp/sentinel.conf &&
        echo 'sentinel parallel-syncs redismaster 1' >> /tmp/sentinel.conf &&
        echo 'sentinel failover-timeout redismaster 10000' >> /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      "
    ports:
      - "26380:26379"
    depends_on:
      redismaster:
        condition: service_healthy
    networks:
      - opencloud-net
    restart: unless-stopped